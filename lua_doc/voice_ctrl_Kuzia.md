# Голосовое управление в SLS

## Введение

В современном мире IoT без голосового управления, умный дом кажется неполноценным. При этом, в кейсах с небольшим количеством устройств бывает нет необходимости в развертывании сервера умного дома, например, Home Assistant. Да и вообще не всегда нужны серверы. На данный момент в SLS поддержка голосового управления в разработке.

## Варианты голосового управления

Их достаточно много. Так сказать на любой вкус и цвет. У каждого есть свои достоинства и недостатки. Мне довелось поработать с двумя. После чего я взялся за разработку собственного решения и преуспел.

1. Навык [Yandex Smart Home](https://yaha-cloud.ru/). Это компонент Home Assistant, который позволяет добавить его устройства в платформу умного дома Яндекса (УДЯ) и управлять ими с любого устройства с Алисой. Облачное решение.
2. Навык [Домовенок Кузя](https://alexstar.ru/smarthome). Это навык УДЯ, который позволяет подключить голосовое управление практически к любому устройству. Работает по протоколам HTTP GET, MQTT (без подписки на топики) и IFTTT. Облачное решение.
3. Мой собственный навык [Преступник Фунтик](https://github.com/tsurkan-av/SLS/blob/main/AliceSkills/funtik/voice_ctrl_Funtik.md). Позволяет интегрировать в УДЯ всё что угодно - зависит от фантазии разработчика. Навык можно развернуть где угодно, где есть node.js. В моем варианте - это Yandex Cloud Functions. 

В данной статье рассматривается вариант интеграции голосового помощника Алиса в SLS через навык [Домовенок Кузя](https://alexstar.ru/smarthome) по протоколу HTTP(S).

Решение разрабатывалось и тестировалось на прошивке версии `2023.01.08d1`, в сети за Keenetic Speedster с прошивкой `3.8.5`, который позволяет организовать доступ в сеть через реверсивный прокси с SSL.

## Требования

Для интеграции требуется:
- доступ из сети Интернет к HTTP API SLS
- учетная запись Yandex
- желательно включить авторизацию на шлюзе

## Настройка доступа из сети Интернет

Для доступа к HTTP API SLS из Интернет возможны различные варианты. Однако, желательна защита соединения сертификатом SSL. Например, Zyxel предлагает сервис [KeenDNS](https://keenetic.pro/) с доменным именем и сертификатом SSL.

## Как это работает

Навык Алисы Домовенок Кузя - это сервис в сети Интернет, который взаимодействуя с Алисой, позволяет управлять устройствами умного дома и не только. Управление возможно по протоколам HTTP, MQTT, а также через платформу [IFTTT](https://ifttt.com/)

Разберем настройку на примере zigbee лампы.

Алгоритм следующий:

- навык принимает и обрабатывает команду от Алисы
- отправляет HTTP GET запрос на SLS для управления 
- получает статус устройства в ответном сообщении SLS или отдельным запросом

Для включения, выключения, изменения яркости лампы используем следующий запрос:

```http
https://addressSLS/api/scripts?token=e9d38bed.......f4ef49476a2ed9575&action=evalFile&path=/kuzia.lua&param=device|state|{value}
```

здесь:

- addressSLS: ip:port или днс адрес шлюза, доступный из сети Интернет
- token: токен шлюза из `Settings -> Users`
- kuzia.lua: скрипт LUA для обработки запроса
- param: параметры, передаваемые в скрипт
  - device: ieee|nwk адрес или FN устройства
  - state: состояние для управления (state|brightness)
  - {value}: сюда навык подставляет значения
    - 0 = выключено
    - 1 = включено
    - 1-100 = значение яркости

Для получения статуса устройства, навыку необходимо вернуть JSON вида

```json
{"value": true|false}
```

Поскольку `api/scripts` возвращает JSON не подходящего формата, будем записывать правильный JSON в отдельное состояние при изменении `state` следующим скриптом:

```lua
local stateON = "{\"value\": true}"
local stateOFF = "{\"value\": false}"
local srcStateVal = zigbee.value(tostring(Event.ieeeAddr), "state")
if (srcStateVal == "ON") then
  zigbee.setState(Event.ieeeAddr, "kuzia", stateON)
elseif (srcStateVal == "OFF") then
  zigbee.setState(Event.ieeeAddr, "kuzia", stateOFF)
end
```

После этого можно запросить статус следующим запросом:

```http
https://sls.tsurkan.keenetic.pro/api/zigbee?token=e9d38bed.......f4ef49476a2ed9575&dev=device&action=getStateValue&name=kuzia
```
